<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุชุฑุฌูุฉ ุงููุจุงุดุฑุฉ - ุงููุงุก</title>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="icon" type="image/png" href="../static/logo.png">
</head>
<body>
    <a href=""><img src="/static/logo.png" class="logo" alt="ุดุนุงุฑ ุฅููุงุก"></a>
    
    <div class="nav-header">
        <button class="back-btn" onclick="window.location.href='/'">
            <span>๐</span> ุงูุฑุฆูุณูุฉ
        </button>
    </div>

    <div class="container">
        <h2 >ุงูุชุฑุฌูุฉ ุงููุจุงุดุฑุฉ</h2>
        <p style="color: #888; margin-bottom: 30px;">
            ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุงุช ุฃูุงู ุงููุงููุฑุง ูุณูููู ุงููุธุงู ุจุชุฑุฌูุชูุง ููุฑุงู
        </p>
        
        <div class="video-container">
            <video id="video" autoplay playsinline muted width="100%" height="100%"></video>
            <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>
            
            <!-- Frame Counter (Green) -->
            <div class="counter frame-counter" id="frameCounter">0/30</div>
            
            <!-- Wait Counter (Red) -->
            <div class="counter wait-counter" id="waitCounter">4</div>
        </div>

        <div>
            <button id="startBtn">๐ฅ ุชุดุบูู ุงููุงููุฑุง</button>

            <div id="toggleContainer">
                <span>ูููุฉ</span>
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider round"></span>
                </label>
                <span>ุญุฑู</span>
            </div>

            <div id="buttonContainer">
                <button id="analysisBtn" style="display:none;">๐ ุจุฏุก ุงูุชุญููู</button>
                <button id="stopBtn" class="stop-btn" style="display:none;">โน ุฅููุงู ูุชุดุบูู ุงูุตูุช</button>
                <button id="clearBtn" class="clear-btn" style="display:none;">๐๏ธ ูุณุญ ุงูุฌููุฉ</button>
            </div>
            
            <div id="wordInfo" class="word-info">
                ุนุฏุฏ ุงููููุงุช: <span id="wordCount">0</span>
            </div>
            
            <div id="textResultDiv">ูู ุงูุชุธุงุฑ ุงูุฅุฏุฎุงู...</div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 10px;">
            <h4 style="color: #0085d0; margin-bottom: 10px;">๐ก ุฅุฑุดุงุฏุงุช ุงูุงุณุชุฎุฏุงู:</h4>
            <ul style="color: #aaa; text-align: right; line-height: 2;">
                <li><strong>ูุถุน ุงููููุฉ:</strong> ุงููุธุงู ูุนูู ูุจุงุดุฑุฉ - ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุฉ ุฎูุงู 3 ุซูุงูู (30 ุฅุทุงุฑ)</li>
                <li><strong>ุจุนุฏ ูู ูููุฉ:</strong> ุงูุชุธุฑ 4 ุซูุงูู ูุจู ุงูุจุฏุก ุจุงููููุฉ ุงูุชุงููุฉ</li>
                <li><strong>ุงูุนุฏุงุฏุงุช:</strong> ุงูุฃุฎุถุฑ ูุนุฑุถ ุงูุฅุทุงุฑุงุช ุงูุญุงููุฉุ ุงูุฃุญูุฑ ูุนุฑุถ ููุช ุงูุงูุชุธุงุฑ</li>
                <li><strong>ุงูุฌููุฉ:</strong> ูุชู ุจูุงุก ุงูุฌููุฉ ุชููุงุฆูุงู ูู ุงููููุงุช ุงูููุชุดูุฉ</li>
                <li><strong>ุงูุตูุช:</strong> ุงุถุบุท "ุฅููุงู ูุชุดุบูู ุงูุตูุช" ููุงุณุชูุงุน ููุฌููุฉ ุงููุงููุฉ</li>
                <li><strong>ูุถุน ุงูุญุฑู:</strong> ุงุซุจุช ุนูู ุฅุดุงุฑุฉ ุงูุญุฑู ูุซุงููุชููุ ุงุฑูุน ูุฏูู ูุนุงู ูุชุญููู ุงููุต ุฅูู ุตูุช</li>
                <li>ุชุฃูุฏ ูู ูุถูุญ ูุฏูู ุฃูุงู ุงููุงููุฑุง</li>
                <li>ุชุฃูุฏ ูู ุฅุถุงุกุฉ ูุนุชุฏูุฉ - ุชุฌูุจ ุงูุฅุถุงุกุฉ ุงูุฎูููุฉ ุงููููุฉ</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const audioPlayer = new Audio();
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const startBtn = document.getElementById('startBtn');
        const textResultDiv = document.getElementById('textResultDiv');
        const toggleContainer = document.getElementById('toggleContainer');
        const modeToggle = document.getElementById('modeToggle');
        const analysisBtn = document.getElementById('analysisBtn');
        const stopBtn = document.getElementById('stopBtn');
        const clearBtn = document.getElementById('clearBtn');
        const frameCounter = document.getElementById('frameCounter');
        const waitCounter = document.getElementById('waitCounter');
        const wordInfo = document.getElementById('wordInfo');
        const wordCount = document.getElementById('wordCount');

        let sendingInterval = null;
        let isStreaming = false;
        let isWordMode = false;
        let frameCount = 0;
        let waitTime = 4;
        let isWaiting = false;

        socket.on('connect', () => {
            console.log("โ ุชู ุงูุงุชุตุงู ุจุงูุฎุงุฏู");
        });

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
                });  
                video.srcObject = stream;
                startBtn.style.display = 'none';
                analysisBtn.style.display = 'inline-block';
                toggleContainer.style.display = 'flex'; 
                textResultDiv.innerText = "ุฌุงูุฒ ููุชุฑุฌูุฉ...";
            } catch(e) {
                textResultDiv.innerText = "ุฎุทุฃ ูู ุงููุงููุฑุง: " + e.message;
                textResultDiv.style.color = 'red';
            }
        };

        modeToggle.onchange = () => {
            isWordMode = modeToggle.checked;
            if (isStreaming) {
                stopAnalysis();
            }
        };

        analysisBtn.onclick = () => {
            if (!isStreaming) {
                socket.emit('flush_sequence');
                startAnalysis();
            }
        };

        stopBtn.onclick = () => {
            stopAnalysis();
            // Request sentence audio from backend
            if (isWordMode) {
                socket.emit('flush_sequence');
                socket.emit('get_sentence_audio');
            }
        };

        clearBtn.onclick = () => {
            socket.emit('clear_sentence');
            socket.emit('flush_sequence');
            textResultDiv.innerText = "ุชู ูุณุญ ุงูุฌููุฉ - ุฌุงูุฒ ููุจุฏุก ูู ุฌุฏูุฏ";
            wordCount.innerText = "0";
        };

        function startAnalysis() {
            isStreaming = true;
            analysisBtn.style.display = 'none';
            stopBtn.style.display = 'inline-block';
            modeToggle.disabled = true;
            
            if (isWordMode) {
                clearBtn.style.display = 'inline-block';
                wordInfo.style.display = 'block';
                startWordMode();
            } else {
                clearBtn.style.display = 'none';
                wordInfo.style.display = 'none';
                startLetterMode();
            }
        }

        function stopAnalysis() {
            isStreaming = false;
            stopBtn.style.display = 'none';
            analysisBtn.style.display = 'inline-block';
            modeToggle.disabled = false;
            clearInterval(sendingInterval);
            
            frameCounter.style.display = 'none';
            waitCounter.style.display = 'none';
            
            frameCount = 0;
            isWaiting = false;
        }

        function startWordMode() {
            frameCount = 0;
            isWaiting = false;
            textResultDiv.innerHTML = '<span class="status-indicator status-live"></span>ุฌุงุฑู ุงูุชุญููู ุงููุจุงุดุฑ...';
            
            frameCounter.style.display = 'block';
            frameCounter.textContent = '0/30';
            
            sendingInterval = setInterval(() => {
                if (isWaiting) {
                    return;
                }
                
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                socket.emit('Word_frame', { b64: b64 });
                
                frameCount++;
                frameCounter.textContent = `${frameCount}/30`;
                
                if (frameCount >= 30) {
                    frameCount = 0;
                    startWaitPeriod();
                }
            }, 1000 / 10);
        }

        function startWaitPeriod() {
            isWaiting = true;
            waitTime = 2;
            
            waitCounter.style.display = 'block';
            waitCounter.textContent = waitTime;
            frameCounter.textContent = 'ุงูุชุธุงุฑ...';
            
            const waitInterval = setInterval(() => {
                waitTime--;
                waitCounter.textContent = waitTime;
                
                if (waitTime <= 0) {
                    clearInterval(waitInterval);
                    waitCounter.style.display = 'none';
                    isWaiting = false;
                    frameCounter.textContent = '0/30';
                }
            }, 1000);
        }

        function startLetterMode() {
            textResultDiv.innerHTML = '<span class="status-indicator status-live"></span>ูุจุงุดุฑ - ูุถุน ุงูุญุฑูู';
            frameCounter.style.display = 'none';
            waitCounter.style.display = 'none';
            
            sendingInterval = setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                socket.emit('Letter_frame', { b64: b64 });
            }, 1000 / 10);
        }

        // Handle word detection results
        socket.on('word_result', (data) => {
            if (data.error) {
                textResultDiv.innerHTML = `<span style="color: #f44336;">ุฎุทุฃ: ${data.error}</span>`;
                return;
            }
            
            if (data.sentence) {
                textResultDiv.innerHTML = `<span class="status-indicator status-live"></span>${data.sentence}`;
                wordCount.innerText = data.word_count || 0;
            }
        });

        // Handle sentence audio
        socket.on('sentence_audio', (data) => {
            if (data.audio_url) {
                audioPlayer.src = data.audio_url;
                audioPlayer.play();
                textResultDiv.innerHTML = `๐ข ${data.sentence}`;
            }
        });

        // Handle sentence cleared
        socket.on('sentence_cleared', () => {
            textResultDiv.innerText = "ุชู ูุณุญ ุงูุฌููุฉ";
            wordCount.innerText = "0";
        });

        // Handle letter mode results
        socket.on('result', (data) => {
            if (typeof data === 'object') {
                textResultDiv.innerText = data.text || "ูู ุงูุชุธุงุฑ ุงูุฅุฏุฎุงู...";
                
                if (data.url) {
                    audioPlayer.src = data.url;
                    audioPlayer.play();
                }
            } else {
                textResultDiv.innerText = data;
            }
        });
    </script>

    <footer style="margin-top: 50px; padding: 20px; text-align: center; color: #666;">
        <p style="padding-bottom: 15px;">ุทูุงุจ ุฌุงูุนุฉ ุงูููู ุณุนูุฏ:</p>
        <p>ุนุจุฏุงูุฑุญูู ุนุงุฆู ูุฏุนุงูู</p>
        <p>ุนุจุฏุงูุฑุญูู ุนุจุฏุงูุญู ุณูุงูุฉ</p>
        <p style="padding-bottom: 10px;">ูุงุฑุณ ุนูู ูุฎุฑุด</p>
        <p>ุฌููุน ุงูุญููู ูุญููุธุฉ ยฉ 2025</p>
    </footer>
</body>
</html>