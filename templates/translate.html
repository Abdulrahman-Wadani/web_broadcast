<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงูุชุฑุฌูุฉ ุงููุจุงุดุฑุฉ - ูุธุงู ูุบุฉ ุงูุฅุดุงุฑุฉ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <img src="/static/logo.png" class="ksu-logo" alt="ุดุนุงุฑ ุฌุงูุนุฉ ุงูููู ุณุนูุฏ">
    
    <div class="nav-header">
        <button class="back-btn" onclick="window.location.href='/'">
            <span>๐</span> ุงูุฑุฆูุณูุฉ
        </button>
    </div>

    <div class="container">
        <h2 style="margin-top: -60px;">ุงูุชุฑุฌูุฉ ุงููุจุงุดุฑุฉ</h2>
        <p style="color: #888; margin-bottom: 30px;">
            ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุงุช ุฃูุงู ุงููุงููุฑุง ูุณูููู ุงููุธุงู ุจุชุฑุฌูุชูุง ููุฑุงู
        </p>
        
        <div style="position: relative; display: inline-block;">
            <video id="video" autoplay playsinline muted width="960" height="540"></video>
            <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>
        </div>

        <div>
            <button id="startBtn">๐ฅ ุชุดุบูู ุงููุงููุฑุง</button>

            <div id="toggleContainer" style="display:none;">
                <span>ุญุฑู</span>
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider round"></span>
                </label>
                <span>ูููุฉ</span>
            </div>

            <div id="buttonContainer" style="position: relative; height: 60px; margin-top: 10px;">
                <button id="analysisBtnBurst" style="display:none;">๐ ุจุฏุก ุงูุชุญููู</button>
                <button id="analysisBtnContinuous" style="display:none;">๐ ุจุฏุก ุงูุชุญููู</button>
            </div>
            
            <div id="timerDiv" style="font-size: 2em; color: #0085d0; height: 40px; font-weight: bold;"></div>
            <div id="textResultDiv">ูู ุงูุชุธุงุฑ ุงูุฅุฏุฎุงู...</div>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 10px;">
            <h4 style="color: #0085d0; margin-bottom: 10px;">๐ก ุฅุฑุดุงุฏุงุช ุงูุงุณุชุฎุฏุงู:</h4>
            <ul style="color: #aaa; text-align: right; line-height: 2;">
                <li><strong>ูุถุน ุงููููุฉ:</strong> ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุฉ ูุงููุฉ ุฎูุงู 3 ุซูุงูู</li>
                <li><strong>ูุถุน ุงูุญุฑู:</strong> ุงุซุจุช ุนูู ุฅุดุงุฑุฉ ุงูุญุฑู ูุซุงููุชููุ ุงุฑูุน ูุฏูู ูุนุงู ูุชุญููู ุงููุต ุฅูู ุตูุช</li>
                <li>ุชุฃูุฏ ูู ูุถูุญ ูุฏูู ุฃูุงู ุงููุงููุฑุง</li>
                <li>ุชุฌูุจ ุงูุฅุถุงุกุฉ ุงูุฎูููุฉ ุงููููุฉ</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const audioPlayer = new Audio();
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const startBtn = document.getElementById('startBtn');
        const timerDiv = document.getElementById('timerDiv');
        const textResultDiv = document.getElementById('textResultDiv');
        const toggleContainer = document.getElementById('toggleContainer');
        const modeToggle = document.getElementById('modeToggle');
        const burstBtn = document.getElementById('analysisBtnBurst');
        const continuousBtn = document.getElementById('analysisBtnContinuous');

        let sendingInterval = null;
        let timerInterval = null;
        let isStreaming = false;

        socket.on('connect', () => {
            console.log("โ ุชู ุงูุงุชุตุงู ุจุงูุฎุงุฏู");
        });

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: { ideal: 1280 }, height: { ideal: 720 } } 
                });  
                video.srcObject = stream;
                startBtn.style.display = 'none';
                burstBtn.style.display = 'inline-block';
                toggleContainer.style.display = 'flex'; 
                textResultDiv.innerText = "ุฌุงูุฒ ููุชุฑุฌูุฉ...";
            } catch(e) {
                textResultDiv.innerText = "ุฎุทุฃ ูู ุงููุงููุฑุง: " + e.message;
                textResultDiv.style.color = 'red';
            }
        };

        modeToggle.onchange = () => {
            if (modeToggle.checked) {
                burstBtn.style.display = 'none';
                continuousBtn.style.display = 'inline-block';
            } else {
                burstBtn.style.display = 'inline-block';
                continuousBtn.style.display = 'none';
            }
        };

        burstBtn.onclick = () => {
            burstBtn.disabled = true;
            modeToggle.disabled = true;
            textResultDiv.innerText = "ุฌุงุฑู ุงูุชุญููู...";
            
            let countdown = 3;
            timerDiv.innerText = countdown;
            let framesSent = 0;

            sendingInterval = setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                socket.emit('Word_frame', { b64: b64 }); 
                
                framesSent++;
                if (framesSent >= 30) {
                    stopRecording();
                }
            }, 1000 / 10);

            timerInterval = setInterval(() => {
                countdown--;
                if (countdown > 0) timerDiv.innerText = countdown;
            }, 1000);

            function stopRecording() {
                clearInterval(timerInterval);
                clearInterval(sendingInterval);
                burstBtn.disabled = false;
                modeToggle.disabled = false;
                timerDiv.innerText = "ุชู โ"; 
            }
        };

        continuousBtn.onclick = () => {
            if (!isStreaming) {
                isStreaming = true;
                continuousBtn.innerText = "โน ุฅููุงู ุงูุชุญููู";
                continuousBtn.style.background = '#d32f2f';
                modeToggle.disabled = true;
                timerDiv.innerText = "ูุจุงุดุฑ ๐ด";
                
                sendingInterval = setInterval(() => {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                    socket.emit('Letter_frame', { b64: b64 });
                }, 1000 / 6);
            } else {
                isStreaming = false;
                continuousBtn.innerText = "๐ ุจุฏุก ุงูุชุญููู";
                continuousBtn.style.background = '#0085d0';
                modeToggle.disabled = false;
                timerDiv.innerText = "";
                clearInterval(sendingInterval);
            }
        };

        socket.on('result', (data) => {
            if(typeof data === 'object'){
                textResultDiv.innerText = data.text || "ูู ุงูุชุธุงุฑ ุงูุฅุฏุฎุงู...";
                if (data.url) {
                    audioPlayer.src = data.url;
                    audioPlayer.play();
                }
            } else {
                textResultDiv.innerText = data;
            }
        });
    </script>
</body>
</html>