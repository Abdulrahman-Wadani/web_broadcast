<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <title>Translate Mode</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>

    <div class="nav-header">
    <button class="back-btn" onclick="window.location.href='/'">
        <span>üè†</span> Home
    </button>
    </div>

    <div class="container">
        <h2 style="margin-top: -80px;">Live Translation</h2>
        
        <div style="position: relative; display: inline-block;">
            <video id="video" autoplay playsinline muted width="960" height="540"></video>
            <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>
        </div>

        <div>
            <button id="startBtn">Start Camera</button>

            <div id="toggleContainer" style="display:none;">
                <span>Word</span>
                <label class="switch">
                    <input type="checkbox" id="modeToggle">
                    <span class="slider round"></span>
                </label>
                <span>Letter</span>
            </div>

            <div id="buttonContainer" style="position: relative; height: 60px; margin-top: 10px;">
                <button id="analysisBtnBurst" style="display:none;">Start Analysis</button>
                <button id="analysisBtnContinuous" style="display:none;">Start Analysis</button>
            </div>
            
            <div id="timerDiv" style="font-size: 2em; color: #00e676; height: 40px;"></div>
            <div id="textResultDiv">Waiting for input...</div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        const audioPlayer = new Audio();
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');

        const startBtn = document.getElementById('startBtn');
        const timerDiv = document.getElementById('timerDiv');
        const textResultDiv = document.getElementById('textResultDiv');
        const toggleContainer = document.getElementById('toggleContainer');
        const modeToggle = document.getElementById('modeToggle');
        const burstBtn = document.getElementById('analysisBtnBurst');
        const continuousBtn = document.getElementById('analysisBtnContinuous');

        let sendingInterval = null;
        let timerInterval = null;
        let isStreaming = false;

        startBtn.onclick = async () => {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: { ideal: 1280 }, height: { ideal: 720 } } });  
                video.srcObject = stream;
                startBtn.style.display = 'none';
                burstBtn.style.display = 'inline-block';
                toggleContainer.style.display = 'flex'; 
            } catch(e) {
                textResultDiv.innerText = "Camera Error: " + e.message;
                textResultDiv.style.color = 'red';
            }
        };

        modeToggle.onchange = () => {
            if (modeToggle.checked) { // Letter Mode
                burstBtn.style.display = 'none';
                continuousBtn.style.display = 'inline-block';
            } else { // Word Mode
                burstBtn.style.display = 'inline-block';
                continuousBtn.style.display = 'none';
            }
        };

        burstBtn.onclick = () => {
    // ÿ™ÿπÿ∑ŸäŸÑ ÿßŸÑÿ£ÿ≤ÿ±ÿßÿ± Ÿàÿ™ÿ¨ŸáŸäÿ≤ ÿßŸÑŸàÿßÿ¨Ÿáÿ©
    burstBtn.disabled = true;
    modeToggle.disabled = true;
    textResultDiv.innerText = "Waiting for analysis...";
    
    // ÿπÿØÿßÿØ ÿ®ÿµÿ±Ÿä (ÿ¥ŸÉŸÑ ŸÅŸÇÿ∑ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ) Ÿäÿ®ÿØÿ£ ŸÖŸÜ 4 ŸÑÿ£ŸÜ ÿßŸÑŸàŸÇÿ™ ÿßŸÑŸÅÿπŸÑŸä 3.75
    let countdown = 3;
    timerDiv.innerText = countdown;

    // ŸÖÿ™ÿ∫Ÿäÿ± ÿØÿßÿÆŸÑŸä ŸÑÿ≠ÿ≥ÿßÿ® ÿπÿØÿØ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ±ÿ≥ŸÑÿ© ŸÅÿπŸÑŸäÿßŸã
    let framesSent = 0;

    // 1. ÿ™ÿ¥ÿ∫ŸäŸÑ ÿ≠ŸÑŸÇÿ© ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ ÿ®ÿ≥ÿ±ÿπÿ© 8 ÿ•ÿ∑ÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿ´ÿßŸÜŸäÿ©
    sendingInterval = setInterval(() => {
        // ÿßŸÑÿ™ŸÇÿßÿ∑ Ÿàÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿµŸàÿ±ÿ©
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
        socket.emit('Word_frame', { b64: b64 }); 
        
        // ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿπÿØÿßÿØ
        framesSent++;

        // 2. ÿßŸÑÿ¥ÿ±ÿ∑ ÿßŸÑÿ≠ÿßÿ≥ŸÖ: ÿ•ÿ∞ÿß ŸàÿµŸÑŸÜÿß 30 ÿµŸàÿ±ÿ© ŸÜÿ™ŸàŸÇŸÅ ŸÅŸàÿ±ÿßŸã
        if (framesSent >= 30) {
            stopRecording();
        }
    }, 1000 / 10); // <--- ŸáŸÜÿß ÿßŸÑÿ≥ÿ±ÿπÿ© 8 ÿ•ÿ∑ÿßÿ±ÿßÿ™

    // 3. ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿ®ÿµÿ±Ÿä (ŸÑŸÑÿ¥ŸÉŸÑ ŸÅŸÇÿ∑)
    timerInterval = setInterval(() => {
        countdown--;
        if (countdown > 0) timerDiv.innerText = countdown;
    }, 1000);

    // ÿØÿßŸÑÿ© ÿßŸÑÿ•ŸäŸÇÿßŸÅ ŸàÿßŸÑÿ™ŸÜÿ∏ŸäŸÅ
    function stopRecording() {
        clearInterval(timerInterval);
        clearInterval(sendingInterval);
        burstBtn.disabled = false;
        modeToggle.disabled = false;
        timerDiv.innerText = "Done"; 
    }
};
        continuousBtn.onclick = () => {
            if (!isStreaming) {
                isStreaming = true;
                continuousBtn.innerText = "Stop Analysis";
                continuousBtn.style.background = '#d32f2f'; // Red color
                modeToggle.disabled = true;
                timerDiv.innerText = "LIVE";
                sendingInterval = setInterval(() => {
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                    socket.emit('Letter_frame', { b64: b64 });
                }, 1000 / 6);
            } else {
                isStreaming = false;
                continuousBtn.innerText = "Start Analysis";
                continuousBtn.style.background = '#00e676';
                modeToggle.disabled = false;
                timerDiv.innerText = "";
                clearInterval(sendingInterval);
            }
        };

        socket.on('result', (data) => {
            if(typeof data === 'object'){
                textResultDiv.innerText = data.text;
                if (data.url) {
                    audioPlayer.src = data.url;
                    audioPlayer.play();
                }
            } else {
                textResultDiv.innerText = data;
            }
        });
    </script>
</body>
</html>