<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ุงุฎุชุจุฑ ููุณู - ูุธุงู ูุบุฉ ุงูุฅุดุงุฑุฉ</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    <img src="/static/logo.png" class="ksu-logo" alt="ุดุนุงุฑ ุฌุงูุนุฉ ุงูููู ุณุนูุฏ">
    
    <div class="nav-header">
        <button class="back-btn" onclick="window.location.href='/'">
            <span>๐</span> ุงูุฑุฆูุณูุฉ
        </button>
    </div>

    <div class="container">
        <h1 style="margin-top: -60px;">ุงุฎุชุจุฑ ููุงุฑุงุชู</h1>
        <p style="color: #888; margin-bottom: 20px;">
            ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุฉ ุงููุทููุจุฉ ูุณูููู ุงููุธุงู ุจุชูููู ุฃุฏุงุฆู
        </p>

        <div id="toggleContainer">
            <span>ูููุงุช</span>
            <label class="switch">
                <input type="checkbox" id="modeToggle"> 
                <span class="slider round"></span>
            </label>
            <span>ุญุฑูู</span>
        </div>

        <div class="target-box">
            <div class="target-label">ูู ุจุฃุฏุงุก:</div>
            <div class="target-word" id="targetDisplay">ุ</div>
            
            <button id="changeBtn" class="word-btn" onclick="generateRandomChallenge()" 
                    style="margin-top:15px; font-size:1rem; width:auto; height:auto; padding:8px 20px;">
                ๐ ุนุดูุงุฆู
            </button>

            <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

            <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
                <select id="manualSelect" class="custom-select"></select>
                <button id="manualBtn" class="word-btn" onclick="setManualChallenge()" 
                        style="font-size:0.9rem; width:auto; height:auto; padding:8px 15px; background: #444;">
                    ุงุฎุชุฑ
                </button>
            </div>
        </div>

        <div class="video-container" style="display:block;">
            <div id="resultOverlay" class="result-overlay">
                <div class="result-text" id="resText">ุงูุชุธุฑ...</div>
                <button class="word-btn" onclick="closeResult()" 
                        style="background: #333; border-color: #777;">ุฅุบูุงู</button>
            </div>
            <div id="overlayTimer" 
                 style="position: absolute; left: 50%; font-size:5rem; color:#0085d0; font-weight:bold; display:none;">3</div>
            <video style="border: none; width: 100%; aspect-ratio: 16/9; background: #000; display: block;" id="video" autoplay playsinline muted></video>
            <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>
        </div>

        <div style="margin-top: 20px;">
            <button id="actionBtn" class="word-btn" 
                    style="width: 300px; height: 70px; font-size: 1.5em; background: #0085d0; color: #000;">
                ๐ธ ุงูุชูุท ุตูุฑุฉ
            </button>
        </div>

        <div style="margin-top: 30px; padding: 20px; background: #1e1e1e; border-radius: 10px;">
            <h4 style="color: #0085d0; margin-bottom: 10px;">๐ ุงูุชุนูููุงุช:</h4>
            <ul style="color: #aaa; text-align: right; line-height: 2;">
                <li><strong>ูุถุน ุงูุญุฑูู:</strong> ุจุนุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุงูุชูุท ุตูุฑุฉ" ุงูุชุธุฑ ุงูุนุฏ ุงูุชูุงุฒูู ุซู ุงุซุจุช ุนูู ุงูุฅุดุงุฑุฉ</li>
                <li><strong>ูุถุน ุงููููุงุช:</strong> ุจุนุฏ ุงูุถุบุท ุนูู ุฒุฑ "ุงุจุฏุฃ ุงูุฃุฏุงุก" ูู ุจุฃุฏุงุก ุงูุฅุดุงุฑุฉ ูุงููุฉ ุฎูุงู 3 ุซูุงูู</li>
                <li>ุงุณุชุฎุฏู ุฒุฑ "ุนุดูุงุฆู" ูุงุฎุชูุงุฑ ุชุญุฏู ุนุดูุงุฆู</li>
                <li>ุฃู ุงุฎุชุฑ ุญุฑู/ูููุฉ ูุญุฏุฏุฉ ูู ุงููุงุฆูุฉ ุงูููุณุฏูุฉ</li>
            </ul>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        const socket = io();
        
        socket.on('connect', () => {
            console.log("โ ูุชุตู ุจุงูุฎุงุฏู");
        });

        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const modeToggle = document.getElementById('modeToggle');
        const targetDisplay = document.getElementById('targetDisplay');
        const actionBtn = document.getElementById('actionBtn');
        const changeBtn = document.querySelector('.word-btn[onclick="generateRandomChallenge()"]');
        const overlayTimer = document.getElementById('overlayTimer');
        const resultOverlay = document.getElementById('resultOverlay');
        const manualSelect = document.getElementById('manualSelect');
        const manualBtn = document.getElementById('manualBtn');

        const lettersList = [
            "ุฃ", "ุจ", "ุช", "ุซ", "ุฌ", "ุญ", "ุฎ", "ุฏ", "ุฐ", "ุฑ", "ุฒ", "ุณ", "ุด", 
            "ุต", "ุถ", "ุท", "ุธ", "ุน", "ุบ", "ู", "ู", "ู", "ู", "ู", "ู", "ู", "ู", "ู"
        ];        
        const wordsList = ["ุฃูุง", "ูุฐุง", "ุงุฑูุฏ", "ุดูุก", "ููุง", "ุงูุงู", "ูุง", "ูู", "ูุงุฐุง", "ุงุฎุฑุณ"];

        let currentMode = 'letter';
        let currentTarget = '';
        let isProcessing = false;

        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { width: 1280, height: 720 } 
                });
                video.srcObject = stream;
            } catch(e) { 
                alert("โ ุฎุทุฃ ูู ุงููุงููุฑุง: " + e.message); 
            }
        }
        startCamera();

        modeToggle.onchange = () => {
            currentMode = modeToggle.checked ? 'word' : 'letter';
            if(currentMode === 'word') {
                actionBtn.innerText = "๐ฅ ุงุจุฏุฃ ุงูุฃุฏุงุก";
                actionBtn.style.background = "#0085d0";
            } else {
                actionBtn.innerText = "๐ธ ุงูุชูุท ุตูุฑุฉ";
                actionBtn.style.background = "#0085d0";
            }
            generateRandomChallenge();
            updateDropdownList();
        };

        function generateRandomChallenge() {
            const list = currentMode === 'word' ? wordsList : lettersList;
            currentTarget = list[Math.floor(Math.random() * list.length)];
            targetDisplay.innerText = currentTarget;
            if(resultOverlay) resultOverlay.style.display = 'none';
        }

        function updateDropdownList() {
            const list = currentMode === 'word' ? wordsList : lettersList;
            manualSelect.innerHTML = "";
            
            list.forEach(item => {
                const option = document.createElement("option");
                option.value = item;
                option.text = item;
                manualSelect.appendChild(option);
            });
        }

        function setManualChallenge() {
            const selectedValue = manualSelect.value;
            if (selectedValue) {
                currentTarget = selectedValue;
                targetDisplay.innerText = currentTarget;
                if(resultOverlay) resultOverlay.style.display = 'none';
            }
        }

        actionBtn.onclick = () => {
            if (isProcessing) return;
            isProcessing = true;
            actionBtn.disabled = true;
            modeToggle.disabled = true;       
            changeBtn.disabled = true;       
            changeBtn.style.opacity = "0.5";
            manualSelect.disabled = true;
            manualBtn.disabled = true;  

            if (currentMode === 'letter') {
                startLetterProcess();
            } else {
                startWordProcess();
            }
        };

        function startLetterProcess() {
            let countdown = 3;
            overlayTimer.style.display = 'block';
            overlayTimer.innerText = countdown;

            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    overlayTimer.innerText = countdown;
                } else {
                    clearInterval(timer);
                    overlayTimer.style.display = 'none';
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    socket.emit('Test_Letter', { b64: b64, target: currentTarget });
                }
            }, 1000);
        }

        function startWordProcess() {
            let frameCount = 0
            actionBtn.innerText = "โบ ุฌุงุฑู ุงูุชุณุฌูู...";
            actionBtn.style.background = "#ff3d00";

            const interval = setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                frameCount++;

                if (frameCount >= 30) {
                    clearInterval(interval);
                    actionBtn.innerText = "โณ ุฌุงุฑู ุงูุชุญููู...";
                }
                socket.emit('Test_Word', { b64: b64, target: currentTarget });

            }, 1000 / 10);
        }

        socket.on('test_response', (serverMessage) => {
            isProcessing = false;
            actionBtn.disabled = false;
            modeToggle.disabled = false;     
            changeBtn.disabled = false;     
            changeBtn.style.opacity = "1";
            manualSelect.disabled = false;
            manualBtn.disabled = false;   
            
            if (currentMode === 'word') {
                actionBtn.innerText = "๐ฅ ุงุจุฏุฃ ุงูุฃุฏุงุก";
                actionBtn.style.background = "#0085d0";
            } else {
                actionBtn.innerText = "๐ธ ุงูุชูุท ุตูุฑุฉ";
                actionBtn.style.background = "#0085d0";
            }

            resultOverlay.style.display = 'block';
            const resText = document.getElementById('resText');
            resText.innerText = serverMessage;
        });

        window.closeResult = function() {
            resultOverlay.style.display = 'none';
        };

        generateRandomChallenge();
        updateDropdownList();
    </script>
</body>
</html>