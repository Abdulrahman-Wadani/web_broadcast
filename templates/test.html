<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Test Yourself</title>
    <link rel="stylesheet" href="/static/style.css">
</head>
<body>
    
    <img src="/static/logo.png" class="ksu-logo" alt="KSU Logo">
    <div class="nav-header">
        <button class="back-btn" onclick="window.location.href='/'">
            <span>ğŸ </span> Home
        </button>
    </div>

    <div class="container">
        <h1 style="margin-top: -80px;">Test Your Skills</h1>

        <div id="toggleContainer" style="display:flex; justify-content:center; gap:15px; margin:20px 0; align-items:center;">
            <span>Letters</span>
            <label class="switch">
                <input type="checkbox" id="modeToggle"> <span class="slider round"></span>
            </label>
            <span>Words</span>
        </div>

        <div class="target-box">
            <div class="target-label">Perform this:</div>
            <div class="target-word" id="targetDisplay">?</div>
            
            <button id="changeBtn" class="word-btn" onclick="generateRandomChallenge()" style="margin-top:15px; font-size:1rem; width:auto; height:auto; padding:8px 20px;">
                ğŸ”„ Random
            </button>

            <hr style="border: 0; border-top: 1px solid #444; margin: 15px 0;">

            <div style="display: flex; justify-content: center; gap: 10px; align-items: center;">
                <button id="manualBtn" class="word-btn" onclick="setManualChallenge()" style="font-size:0.9rem; width:auto; height:auto; padding:8px 15px; background: #444;">
                    Select
                </button>
                <select id="manualSelect" class="custom-select">
                    </select>
                
            </div>
        </div>

        <div class="video-container" style="display:block;">
            <div id="resultOverlay" class="result-overlay">
                <div class="result-text" id="resText">Wait...</div>
                <button class="word-btn" onclick="closeResult()" style="background: #333; border-color: #777;">Close</button>
            </div>
            <div id="overlayTimer" style="position: absolute; left: 50%; font-size:5rem; color:#0085d0; font-weight:bold; display:none;">3</div>
            <video id="video" autoplay playsinline muted></video>
            <canvas id="canvas" width="1280" height="720" style="display:none;"></canvas>
        </div>

        <div style="margin-top: 20px;">
            <button id="actionBtn" class="word-btn" style="width: 300px; height: 70px; font-size: 1.5em; background: #0085d0; color: #000;">
                Take Picture ğŸ“¸
            </button>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script>
        // 1. Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø³ÙŠØ±ÙØ±
        const socket = io();
        
        socket.on('connect', () => {
            console.log("âœ… Connected to Server!");
        });

        // ØªØ¹Ø±ÙŠÙ Ø§Ù„Ø¹Ù†Ø§ØµØ±
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const modeToggle = document.getElementById('modeToggle');
        const targetDisplay = document.getElementById('targetDisplay');
        const actionBtn = document.getElementById('actionBtn');
        const changeBtn = document.querySelector('.word-btn[onclick="generateRandomChallenge()"]');
        const overlayTimer = document.getElementById('overlayTimer');
        const resultOverlay = document.getElementById('resultOverlay');
        const manualSelect = document.getElementById('manualSelect');
        const manualBtn = document.getElementById('manualBtn');
        

        const lettersList = [
            "Ø£", "Ø¨", "Øª", "Ø«", "Ø¬", "Ø­", "Ø®", "Ø¯", "Ø°", "Ø±", "Ø²", "Ø³", "Ø´", 
            "Øµ", "Ø¶", "Ø·", "Ø¸", "Ø¹", "Øº", "Ù", "Ù‚", "Ùƒ", "Ù„", "Ù…", "Ù†", "Ù‡", "Ùˆ", "ÙŠ"
        ];        
        const wordsList = ["Ø£Ù†Ø§", "Ù‡Ø°Ø§", "Ø§Ø±ÙŠØ¯", "Ø´ÙŠØ¡", "Ù‡Ù†Ø§", "Ø§Ù„Ø§Ù†", "Ù„Ø§", "ÙÙŠ", "Ù…Ø§Ø°Ø§", "Ø§Ø®Ø±Ø³"];

        let currentMode = 'letter';
        let currentTarget = '';
        let isProcessing = false;

        // ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 1280, height: 720 } });
                video.srcObject = stream;
            } catch(e) { 
                alert("âŒ Camera Error: " + e.message); 
            }
        }
        startCamera();

        // Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
        modeToggle.onchange = () => {
            currentMode = modeToggle.checked ? 'word' : 'letter';
            if(currentMode === 'word') {
                actionBtn.innerText = "Start Performing ğŸ¥";
                actionBtn.style.background = "#0085d0";
            } else {
                actionBtn.innerText = "Take Picture ğŸ“¸";
                actionBtn.style.background = "#0085d0";
            }
            generateRandomChallenge();
            updateDropdownList();
        };

        // ØªÙˆÙ„ÙŠØ¯ ØªØ­Ø¯ÙŠ
        function generateRandomChallenge() {
            const list = currentMode === 'word' ? wordsList : lettersList;
            currentTarget = list[Math.floor(Math.random() * list.length)];
            targetDisplay.innerText = currentTarget;
            if(resultOverlay) resultOverlay.style.display = 'none';
        }

        // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© Ù…Ù„Ø¡ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---
        function updateDropdownList() {
            const list = currentMode === 'word' ? wordsList : lettersList;
            manualSelect.innerHTML = ""; // ØªÙØ±ÙŠØº Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
            
            list.forEach(item => {
                const option = document.createElement("option");
                option.value = item;
                option.text = item;
                manualSelect.appendChild(option);
            });
        }

        // --- (Ø¬Ø¯ÙŠØ¯) Ø¯Ø§Ù„Ø© ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠØ¯ÙˆÙŠ ---
        function setManualChallenge() {
            const selectedValue = manualSelect.value;
            if (selectedValue) {
                currentTarget = selectedValue;
                targetDisplay.innerText = currentTarget;
                // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ù†ØªÙŠØ¬Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©
                if(resultOverlay) resultOverlay.style.display = 'none';
            }
        }

        // --- 2. Ø¹Ù†Ø¯ Ø¶ØºØ· Ø§Ù„Ø²Ø± (Debug) ---
        actionBtn.onclick = () => {
            // ÙØ­Øµ: Ù‡Ù„ Ø§Ù„Ø²Ø± ÙŠØ³ØªØ¬ÙŠØ¨ØŸ
            console.log("Button Pressed!"); 

            if (isProcessing) return;
            isProcessing = true;
            actionBtn.disabled = true;
            modeToggle.disabled = true;       
            changeBtn.disabled = true;       
            changeBtn.style.opacity = "0.5";
            manualSelect.disabled = true;
            manualBtn.disabled = true;  

            if (currentMode === 'letter') {
                startLetterProcess();
            } else {
                startWordProcess();
            }
        };

        function startLetterProcess() {
            let countdown = 3;
            overlayTimer.style.display = 'block';
            overlayTimer.innerText = countdown;

            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    overlayTimer.innerText = countdown;
                } else {
                    clearInterval(timer);
                    overlayTimer.style.display = 'none';
                    // Ø§Ù„ØªÙ‚Ø§Ø· ÙˆØ¥Ø±Ø³Ø§Ù„
                    ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const b64 = canvas.toDataURL('image/jpeg', 0.8).split(',')[1];
                    
                    console.log("Sending Letter to server..."); // ÙØ­Øµ
                    socket.emit('Test_Letter', { b64: b64, target: currentTarget });
                }
            }, 1000);
        }

        function startWordProcess() {
            let frames = [];
            let frameCount = 0;
            actionBtn.innerText = "Recording...";
            actionBtn.style.background = "#ff3d00";

            const interval = setInterval(() => {
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
                frames.push(b64);
                frameCount++;

                if (frameCount >= 30) {
                    clearInterval(interval);
                    actionBtn.innerText = "Analyzing...";
                    
                    console.log("Sending Word Batch to server..."); // ÙØ­Øµ
                    socket.emit('Test_Word_Batch', { frames: frames, target: currentTarget });
                }
            }, 1000 / 8);
        }

        // --- 3. Ø§Ø³ØªÙ‚Ø¨Ø§Ù„ Ø§Ù„Ø±Ø¯ ---
        socket.on('test_response', (serverMessage) => {
            console.log("Server responded:", serverMessage); // ÙØ­Øµ
            
            isProcessing = false;
            actionBtn.disabled = false;
            modeToggle.disabled = false;     
            changeBtn.disabled = false;     
            changeBtn.style.opacity = "1";
            manualSelect.disabled = false;
            manualBtn.disabled = false;   
            if (currentMode === 'word') {
                actionBtn.innerText = "Start Performing ğŸ¥";
                actionBtn.style.background = "#0085d0";
            } else {
                actionBtn.innerText = "Take Picture ğŸ“¸";
                actionBtn.style.background = "#0085d0";
            }

            // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù†ØªÙŠØ¬Ø©
            resultOverlay.style.display = 'block';
            const resIcon = document.getElementById('resIcon');
            const resText = document.getElementById('resText');


            resText.innerText = serverMessage;
        });

        window.closeResult = function() {
            resultOverlay.style.display = 'none';
        };

        // Ø¨Ø¯Ø¡
        generateRandomChallenge();
        updateDropdownList();
    </script>
</body>
</html>