<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Broadcaster</title>
<style>
body{background:#111;color:#eee;text-align:center;font-family:sans-serif}
video{border:2px solid #444; background: #222;}
#result{font-size: 1.5em; color: #0f0; margin-top: 10px;}
</style>
</head>
<body>
<h2>Broadcaster</h2>
<button id="startBtn">Start</button><br><br>
<video id="video" autoplay playsinline muted width="640" height="360"></video>
<canvas id="canvas" width="1920" height="1080" style="display:none;"></canvas>

<div id="result">...</div>

<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script>
const socket = io();
const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d');
const resultDiv = document.getElementById('result'); 
const startBtn = document.getElementById('startBtn');

// للتأكد أننا متصلون
socket.on('connect', () => {
  console.log('Socket.IO Connected!');
});

// 1. بدء البث
startBtn.onclick = async () => {
try {
const constraints = {
  video: {
    width: { ideal: 1920 },
    height: { ideal: 1080 }
  }
};
const stream = await navigator.mediaDevices.getUserMedia(constraints);
video.srcObject = stream;
startBtn.style.display = 'none'; // إخفاء الزر
// 2. بدء حلقة الإرسال (5 مرات في الثانية)
setInterval(() => {
ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
const b64 = canvas.toDataURL('image/jpeg', 0.5).split(',')[1];
// 3. إرسال الإطار إلى الخادم
socket.emit('frame', { b64: b64 });
}, 1000 / 10); 
} catch(e) {
resultDiv.innerText = e.message;
resultDiv.style.color = 'red';
}
};

// 4. استقبال النتيجة
socket.on('result', (text) => {
resultDiv.innerText = text; // عرض النص العائد من الخادم
});
</script>
</body>
</html>